<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Çizim ve Düzenleme Aracı</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js Kütüphanesi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Font Awesome İkonlar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e293b',
                    },
                    cursor: {
                        'crosshair': 'crosshair',
                        'text': 'text',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f3f4f6;
            touch-action: none; /* Mobilde kaydırmayı engellemek için */
        }
        #canvas-wrapper {
            position: relative;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            margin: 0 auto;
            background-color: white;
            display: inline-block; /* İçeriğe göre genişlemesi için */
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        #pdf-render {
            z-index: 1; /* Altta PDF */
        }
        #draw-layer {
            z-index: 10; /* Üstte çizim katmanı */
            cursor: crosshair;
        }
        .tool-btn {
            transition: all 0.2s;
        }
        .tool-btn.active {
            background-color: #e0e7ff;
            color: #3b82f6;
            border-color: #3b82f6;
        }
        #text-input-overlay {
            position: absolute;
            display: none;
            z-index: 20;
            background: transparent;
            border: 1px dashed #3b82f6;
            padding: 4px;
            font-family: sans-serif;
            outline: none;
            min-width: 100px;
            color: black;
            font-size: 16px;
        }
        /* Drop Zone */
        #drop-zone {
            transition: all 0.3s ease;
        }
        #drop-zone.dragover {
            background-color: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            transform: scale(1.02);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Üst Araç Çubuğu -->
    <header class="bg-white border-b border-gray-200 px-4 py-3 shadow-sm flex items-center justify-between z-30 shrink-0">
        <div class="flex items-center gap-4">
            <h1 class="font-bold text-xl text-primary flex items-center gap-2">
                <i class="fa-solid fa-file-pdf"></i> PDF<span class="text-slate-600 font-normal">Editör</span>
            </h1>
            
            <!-- Dosya Yükleme -->
            <label class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded-md text-sm transition font-medium">
                <i class="fa-solid fa-upload mr-1"></i> PDF Aç
                <input type="file" id="file-input" accept="application/pdf" class="hidden">
            </label>
        </div>

        <!-- Araçlar -->
        <div class="flex items-center gap-2 bg-slate-50 p-1.5 rounded-lg border border-gray-200" id="toolbar">
            <button onclick="setTool('cursor')" id="btn-cursor" class="tool-btn active p-2 rounded hover:bg-white hover:shadow-sm" title="Seç / Taşı">
                <i class="fa-solid fa-arrow-pointer"></i>
            </button>
            <div class="w-px h-6 bg-gray-300 mx-1"></div>
            
            <button onclick="setTool('pen')" id="btn-pen" class="tool-btn p-2 rounded hover:bg-white hover:shadow-sm" title="Kalem">
                <i class="fa-solid fa-pen"></i>
            </button>
            
            <button onclick="setTool('text')" id="btn-text" class="tool-btn p-2 rounded hover:bg-white hover:shadow-sm" title="Metin Yaz">
                <i class="fa-solid fa-font"></i>
            </button>
            
            <button onclick="clearCanvas()" class="tool-btn p-2 rounded hover:bg-red-50 text-red-500 hover:text-red-600" title="Sayfayı Temizle">
                <i class="fa-solid fa-trash"></i>
            </button>

            <div class="w-px h-6 bg-gray-300 mx-1"></div>

            <!-- Renk ve Boyut -->
            <div class="flex items-center gap-2 px-2">
                <input type="color" id="color-picker" value="#000000" class="w-8 h-8 rounded cursor-pointer border-0 bg-transparent">
                <select id="line-width" class="bg-transparent text-sm border-b border-gray-300 focus:outline-none pb-1 w-16">
                    <option value="2">İnce</option>
                    <option value="5" selected>Orta</option>
                    <option value="10">Kalın</option>
                </select>
            </div>
        </div>

        <!-- Kaydetme ve Sayfalama -->
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-1 bg-slate-100 rounded-md px-2 py-1" id="pagination-controls" style="visibility: hidden;">
                <button onclick="changePage(-1)" class="p-1 hover:text-primary"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="page-num" class="text-sm font-medium w-12 text-center">0 / 0</span>
                <button onclick="changePage(1)" class="p-1 hover:text-primary"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <button onclick="downloadPage()" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-md shadow-sm transition text-sm font-medium">
                <i class="fa-solid fa-image mr-1"></i> İndir (Resim)
            </button>
        </div>
    </header>

    <!-- Ana Çalışma Alanı -->
    <main class="flex-1 overflow-auto bg-slate-200 relative flex justify-center p-8" id="main-container">
        
        <!-- Sürükle Bırak Alanı (Başlangıçta Görünür) -->
        <div id="drop-zone" class="absolute inset-4 border-4 border-dashed border-gray-300 bg-white rounded-xl flex flex-col items-center justify-center z-50">
            <div class="text-center p-10">
                <i class="fa-solid fa-file-pdf text-6xl text-gray-300 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-700 mb-2">PDF Dosyasını Buraya Sürükleyin</h2>
                <p class="text-gray-500 mb-6">veya yukarıdaki "PDF Aç" butonunu kullanın</p>
                <button onclick="document.getElementById('file-input').click()" class="bg-primary text-white px-6 py-3 rounded-lg shadow hover:bg-blue-600 transition">
                    Dosya Seç
                </button>
            </div>
        </div>

        <!-- Canvas Wrapper (PDF + Çizim) -->
        <div id="canvas-wrapper" style="display: none;">
            <canvas id="pdf-render"></canvas>
            <canvas id="draw-layer"></canvas>
            <div id="text-input-overlay" contenteditable="true"></div>
        </div>

    </main>

    <script>
        // PDF.js Worker ayarı (CDN kullanımı)
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Değişkenler
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.5;
        let canvasWrapper = document.getElementById('canvas-wrapper');
        let pdfCanvas = document.getElementById('pdf-render');
        let drawCanvas = document.getElementById('draw-layer');
        let pdfCtx = pdfCanvas.getContext('2d');
        let drawCtx = drawCanvas.getContext('2d');
        let textOverlay = document.getElementById('text-input-overlay');
        
        // Araç durumu
        let currentTool = 'cursor'; // cursor, pen, text
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let drawingColor = '#000000';
        let lineWidth = 5;

        // Dosya Yükleme Eventleri
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');

        fileInput.addEventListener('change', handleFileSelect);

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            e.stopPropagation();
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', (e) => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.stopPropagation();
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                loadPDF(files[0]);
            } else {
                alert('Lütfen geçerli bir PDF dosyası yükleyin.');
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                loadPDF(file);
            }
        }

        // PDF Yükleme
        function loadPDF(file) {
            const fileReader = new FileReader();
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);

                pdfjsLib.getDocument(typedarray).promise.then(function(pdfDoc_) {
                    pdfDoc = pdfDoc_;
                    document.getElementById('drop-zone').style.display = 'none';
                    canvasWrapper.style.display = 'block';
                    document.getElementById('pagination-controls').style.visibility = 'visible';
                    document.getElementById('page-num').textContent = `${pageNum} / ${pdfDoc.numPages}`;
                    
                    // İlk sayfayı renderla
                    renderPage(pageNum);
                });
            };
            fileReader.readAsArrayBuffer(file);
        }

        // Sayfa Renderlama
        function renderPage(num) {
            pageRendering = true;
            
            // PDF sayfasını al
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({scale: scale});
                
                // Canvas boyutlarını ayarla
                pdfCanvas.height = viewport.height;
                pdfCanvas.width = viewport.width;
                drawCanvas.height = viewport.height;
                drawCanvas.width = viewport.width;
                
                canvasWrapper.style.width = viewport.width + 'px';
                canvasWrapper.style.height = viewport.height + 'px';

                // PDF'i alt katmana çiz
                const renderContext = {
                    canvasContext: pdfCtx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);

                renderTask.promise.then(function() {
                    pageRendering = false;
                    // Eğer bekleyen sayfa varsa onu çiz
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });

            // Sayfa numarasını güncelle
            document.getElementById('page-num').textContent = `${num} / ${pdfDoc.numPages}`;
            
            // Yeni sayfaya geçince çizimleri temizle (veya saklamak istersen burayı düzenle)
            // Bu demo'da her sayfa değiştiğinde çizimler temizleniyor.
            // Gelişmiş versiyonlarda çizimleri sayfa bazlı dizilerde saklayabiliriz.
            clearCanvas(); 
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function changePage(offset) {
            if (!pdfDoc) return;
            const newPage = pageNum + offset;
            if (newPage >= 1 && newPage <= pdfDoc.numPages) {
                pageNum = newPage;
                queueRenderPage(pageNum);
            }
        }

        // Araç Seçimi
        function setTool(tool) {
            currentTool = tool;
            
            // UI Güncelleme
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${tool}`).classList.add('active');

            // İmleç Ayarı
            if (tool === 'pen') {
                drawCanvas.style.cursor = 'crosshair';
            } else if (tool === 'text') {
                drawCanvas.style.cursor = 'text';
            } else {
                drawCanvas.style.cursor = 'default';
            }
        }

        // Renk ve Boyut Ayarları
        document.getElementById('color-picker').addEventListener('change', (e) => {
            drawingColor = e.target.value;
            if(textOverlay.style.display === 'block') {
                textOverlay.style.color = drawingColor;
            }
        });

        document.getElementById('line-width').addEventListener('change', (e) => {
            lineWidth = parseInt(e.target.value);
        });

        // Çizim İşlemleri (Mouse & Touch)
        function startPosition(e) {
            if (currentTool !== 'pen') return;
            isDrawing = true;
            draw(e);
        }

        function endPosition() {
            isDrawing = false;
            drawCtx.beginPath();
        }

        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            // Mouse veya Touch eventi kontrolü
            const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
            const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
            
            return {
                x: (clientX - rect.left) * (canvas.width / rect.width),
                y: (clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function draw(e) {
            if (!isDrawing || currentTool !== 'pen') return;
            e.preventDefault(); // Sayfa kaymasını engelle

            const pos = getMousePos(drawCanvas, e);

            drawCtx.lineWidth = lineWidth;
            drawCtx.lineCap = 'round';
            drawCtx.strokeStyle = drawingColor;

            drawCtx.lineTo(pos.x, pos.y);
            drawCtx.stroke();
            drawCtx.beginPath();
            drawCtx.moveTo(pos.x, pos.y);
        }

        // Event Listeners for Drawing
        drawCanvas.addEventListener('mousedown', startPosition);
        drawCanvas.addEventListener('mouseup', endPosition);
        drawCanvas.addEventListener('mousemove', draw);
        
        // Touch support
        drawCanvas.addEventListener('touchstart', startPosition, {passive: false});
        drawCanvas.addEventListener('touchend', endPosition);
        drawCanvas.addEventListener('touchmove', draw, {passive: false});

        // Metin Ekleme İşlemleri
        drawCanvas.addEventListener('click', (e) => {
            if (currentTool !== 'text') {
                finalizeText(); // Başka yere tıklarsa mevcut yazıyı bitir
                return;
            }
            
            // Eğer zaten yazı yazıyorsak, önce onu tamamla
            if (textOverlay.style.display === 'block') {
                finalizeText();
                return;
            }

            const pos = getMousePos(drawCanvas, e);
            
            // Input kutusunu konumlandır
            textOverlay.style.left = (pos.x / (drawCanvas.width / drawCanvas.clientWidth)) + 'px';
            textOverlay.style.top = (pos.y / (drawCanvas.height / drawCanvas.clientHeight)) + 'px';
            textOverlay.style.display = 'block';
            textOverlay.style.color = drawingColor;
            textOverlay.style.fontSize = (lineWidth * 3 + 10) + 'px'; // Kalınlığa göre font boyutu
            textOverlay.innerText = '';
            textOverlay.focus();
        });

        // Yazıyı Canvas'a İşle (Enter veya dışarı tıklama)
        function finalizeText() {
            if (textOverlay.style.display === 'none' || textOverlay.innerText.trim() === '') {
                textOverlay.style.display = 'none';
                return;
            }

            const rect = textOverlay.getBoundingClientRect();
            const canvasRect = drawCanvas.getBoundingClientRect();
            
            // Göreceli pozisyonu hesapla (Canvas'ın gerçek çözünürlüğüne göre)
            const x = (rect.left - canvasRect.left) * (drawCanvas.width / canvasRect.width);
            const y = (rect.top - canvasRect.top) * (drawCanvas.height / canvasRect.height); // + font boyutu kadar offset gerekebilir

            drawCtx.font = `${textOverlay.style.fontSize} sans-serif`;
            drawCtx.fillStyle = textOverlay.style.color;
            drawCtx.textBaseline = 'top';
            drawCtx.fillText(textOverlay.innerText, x, y + 2); // Ufak bir dikey düzeltme

            textOverlay.innerText = '';
            textOverlay.style.display = 'none';
        }

        // Canvas Temizleme
        function clearCanvas() {
            drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
        }

        // Görüntü Olarak İndir (Merge PDF + Draw Layers)
        function downloadPage() {
            if(!pdfDoc) return;
            
            // Geçici bir canvas oluştur
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = pdfCanvas.width;
            tempCanvas.height = pdfCanvas.height;
            const tempCtx = tempCanvas.getContext('2d');

            // Önce PDF'i çiz
            tempCtx.drawImage(pdfCanvas, 0, 0);
            // Sonra çizimleri çiz
            tempCtx.drawImage(drawCanvas, 0, 0);

            // İndirme linki oluştur
            const link = document.createElement('a');
            link.download = `pdf-duzenlendi-sayfa-${pageNum}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        }

    </script>
</body>
</html
